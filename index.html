<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>English Reading Evaluation</title>
  <style>
    body {
      background: #F0F8FF;
      font-family: 'Poppins', 'Nunito', 'Comic Sans MS', Arial, sans-serif;
      color: #333;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    .container { max-width: 550px; margin: 32px auto 24px; background: #fff; border-radius: 24px; padding: 24px 18px 10px; box-shadow: 0 6px 24px #4A90E222; }
    h1 { color: #4A90E2; font-size: 2rem; font-weight: bolder; margin-bottom: 8px; }
    label { font-weight: bold; color: #50C878; font-size: 1.16rem;}
    textarea, input[type="text"] { width: 98%; min-height: 80px; border-radius: 16px; border: 2px solid #FFA500; padding: 12px; font-size: 1.08rem; margin-bottom: 10px;}
    button, .audio-btn { border: none; outline: none; padding: 15px 28px; margin: 8px 5px; border-radius: 25px; color: #fff; font-size: 1.15rem; font-weight: bold; cursor: pointer; background: #4A90E2; transition: all 0.22s; box-shadow: 0 3px 10px #4A90E244;}
    button:hover, .audio-btn:hover { background: #FF69B4; transform: scale(1.06);}
    .start-btn { background: #50C878; }
    .stop-btn { background: #FF4444; }
    .score-card { display: flex; justify-content: center; gap: 16px; margin-top: 8px;}
    .score { background: #FFD700; color: #333; border-radius: 16px; padding: 12px 18px; font-size: 1.2rem; font-weight: bold;}
    .error-word { color: #FF4444; text-decoration: underline wavy red; font-weight: bolder;}
    .correct-word { color: #333;}
    .audio-controls { display: flex; flex-direction: column; align-items: center; margin-bottom: 8px; }
    .slider { width: 80%; margin: 10px auto;}
    .subtitle { color:#B19CD9;font-weight:bolder;font-size:1.08em;margin-top:0.4em;margin-bottom:0.8em;}
    @media (max-width: 600px) {
      .container {padding: 12px 2px;}
      button, .audio-btn {font-size:1rem;padding:9px 13px;}
      h1 {font-size: 1.4rem;}
      .score-card {gap: 8px;}
      .score {padding: 7px 12px;font-size: 1rem;}
    }
  </style>
</head>
<body>
  <div class="container" id="main">
    <h1>üìö English Reading Practice</h1>
    <div id="step-textinput">
      <label for="textInput">Paste or type the reading text:</label><br>
      <textarea id="textInput" placeholder="e.g. The quick brown fox jumps over the lazy dog."></textarea><br>
      <button onclick="goToRecord()" id="beginBtn" class="start-btn">Start Evaluation</button>
    </div>

    <div id="step-record" style="display:none;">
      <div class="subtitle">Read the text aloud as clearly as you can.<br>(Press green button to start)</div>
      <div id="showText" style="font-size:1.17em;line-height:1.9;margin-top:8px;margin-bottom:18px;"></div>
      <button class="start-btn" id="recBtn" onclick="startRecord()">üé§ Start Recording</button>
      <button class="stop-btn" id="stopBtn" style="display:none;" onclick="stopRecord()">‚èπ Stop Recording</button>
      <div id="recStatus"></div>
    </div>

    <div id="step-result" style="display:none;">
      <div class="subtitle">Result & Feedback</div>
      <div id="showCompare"></div>
      <div id="showErrList"></div>
      <div class="score-card">
        <div class="score" id="scorePron">Pronunciation: --</div>
        <div class="score" id="scoreSpeed">Speed: --</div>
        <div class="score" id="scoreComp">Completeness: --</div>
        <div class="score" id="scoreTotal">Total: --</div>
      </div>
      <button class="audio-btn" onclick="goToAudio()">Reference Audio</button>
      <button onclick="restart()" style="background:#B19CD9;">Try Again</button>
    </div>

    <div id="step-audio" style="display:none;">
      <div class="subtitle">Listen to British Female Reading</div>
      <div class="audio-controls">
        <button class="audio-btn" id="ttsPlayBtn" onclick="playTTS()">‚ñ∂ Play</button>
        <button class="audio-btn" id="ttsPauseBtn" onclick="pauseTTS()">‚è∏ Pause</button>
        <label>Speech Rate: <span id="rateDisplay">1.0</span></label>
        <input type="range" min="0.5" max="2" value="1" step="0.1" id="rateSlider" class="slider" oninput="setTTSRate(this.value)">
      </div>
      <button onclick="restart()" style="background:#B19CD9;">Back</button>
    </div>

    <div style="margin-top:26px; color:#999; font-size:0.9em;">
      created by Kana Leong (2025)
    </div>
  </div>

  <script>
    //-------------------- ÂÖ®Â±ÄËÆäÊï∏ ------------------------
    let origText = ""; // ÂéüÊñá
    let recText = "";  // Ë™ûÈü≥Ë≠òÂà•ÁµêÊûú
    let recordStart = 0, recordEnd = 0;
    let recorder, chunks = [];
    let recognition;
    let ttsUtterance, ttsRate = 1.0;

    //------------------- 1. Ë∑≥Âà∞ÈåÑÈü≥ ---------------------
    function goToRecord() {
      let textVal = document.getElementById('textInput').value.trim();
      if (!textVal || textVal.length < 4) { alert("Ë´ãËº∏ÂÖ•ÊúóËÆÄÂÖßÂÆπÔºà‰∏çÂ∞ëÊñº4ÂÄãÂ≠óÔºâ"); return; }
      origText = textVal.replace(/\s+/g," ").trim();
      document.getElementById('showText').innerText = origText;
      document.getElementById('step-textinput').style.display = 'none';
      document.getElementById('step-record').style.display = '';
      document.getElementById('recStatus').innerText = '';
    }

    //------------------- 2. ÈñãÂßãÈåÑÈü≥ ---------------------
    function startRecord() {
      recordStart = Date.now();
      document.getElementById('recStatus').innerText = "Recording...";
      document.getElementById('recBtn').style.display = 'none';
      document.getElementById('stopBtn').style.display = '';
      // ÂïüÂãïË™ûÈü≥Ë≠òÂà•
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        alert("ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ë≠òÂà•ÔºåË´ã‰ΩøÁî® Chrome/Safari ÊúÄÊñ∞ÁâàÊú¨„ÄÇ"); return;
      }
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-GB';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onresult = function(event) {
        recText = event.results[0][0].transcript;
        recordEnd = Date.now();
        document.getElementById('recStatus').innerText = "Processing...";
        showResults();
      }
      recognition.onerror = function(event) {
        document.getElementById('recStatus').innerText = "Ë™ûÈü≥Ë≠òÂà•Â§±ÊïóÔºåË´ãÈáçË©¶„ÄÇ";
        document.getElementById('recBtn').style.display = '';
        document.getElementById('stopBtn').style.display = 'none';
      }
      recognition.start();
    }
    //------------------- 3. ÂÅúÊ≠¢ÈåÑÈü≥ ---------------------
    function stopRecord() {
      if (recognition) recognition.stop();
      document.getElementById('recBtn').style.display = '';
      document.getElementById('stopBtn').style.display = 'none';
      document.getElementById('recStatus').innerText = "Evaluating...";
    }

    //------------------- 4. È°ØÁ§∫ÁµêÊûú ---------------------
    function showResults() {
      document.getElementById('step-record').style.display = 'none';
      document.getElementById('step-result').style.display = '';
      let origArr = origText.split(' ');
      let recArr = recText.split(' ');
      // Â≠óË©ûÁ¥öÊØîÂ∞çÔºàÁ∞°ÂñÆÂåπÈÖç+LevenshteinÔºâ
      let marked = '';
      let errors = [];
      for (let i=0;i<origArr.length;i++) {
        let rw = recArr[i] || "";
        if (rw.toLowerCase() === origArr[i].toLowerCase()) {
          marked += `<span class="correct-word">${origArr[i]}</span> `;
        } else {
          marked += `<span class="error-word">${origArr[i]}</span> `;
          if (rw) errors.push(`${origArr[i]} ‚áÑ ${rw}`);
          else errors.push(`${origArr[i]} (missing)`);
        }
      }
      document.getElementById('showCompare').innerHTML = marked;
      if (errors.length)
        document.getElementById('showErrList').innerHTML = `<div><b>Pronunciation issues:</b></div><ul style='color:#FF4444;font-weight:bold;line-height:1.7;'>${errors.map(e=>`<li>${e}</li>`).join('')}</ul>`;
      else
        document.getElementById('showErrList').innerHTML = `<span style="color:#50C878;font-weight:bolder;">Perfect! No mistakes detected.</span>`;

      // Ë©ïÂàÜ
      let correct = origArr.filter((w,i) => (recArr[i]||"").toLowerCase() === w.toLowerCase()).length;
      let pronunciation = Math.round(correct/origArr.length*100);
      let completeness = Math.round(recArr.length/origArr.length*100>100?100:recArr.length/origArr.length*100);
      let duration = ((recordEnd-recordStart)/1000);
      let wpm = Math.round(recArr.length/duration*60);
      let speed = wpm<80 || wpm>150 ? Math.max(0,100-Math.abs(wpm-115)) : 100;
      let total = Math.round(pronunciation*0.5+speed*0.2+completeness*0.3);

      document.getElementById('scorePron').innerText = `Pronunciation: ${pronunciation}`;
      document.getElementById('scoreComp').innerText = `Completeness: ${completeness}`;
      document.getElementById('scoreSpeed').innerText = `Speed: ${speed}`;
      document.getElementById('scoreTotal').innerText = `Total: ${total}`;
    }

    //------------------- 5. ÂèÉËÄÉÈü≥È†ª ---------------------
    function goToAudio() {
      document.getElementById('step-result').style.display='none';
      document.getElementById('step-audio').style.display='';
      setTTSRate(ttsRate);
    }
    function playTTS() {
      if (ttsUtterance) window.speechSynthesis.cancel();
      ttsUtterance = new SpeechSynthesisUtterance(origText);
      ttsUtterance.lang = 'en-GB';
      ttsUtterance.rate = ttsRate;
      ttsUtterance.volume = 0.85;
      let voices = speechSynthesis.getVoices().filter(v=>v.lang.startsWith('en-GB') && v.name.toLowerCase().includes('female'));
      if (voices.length>0) ttsUtterance.voice = voices[0];
      else { // ‰øùÂ∫ïÔºöÊâæËã±Ë™û„ÄÅÂ•≥ÊÄß
        voices = speechSynthesis.getVoices().filter(v=>v.lang.startsWith('en') && v.name.toLowerCase().includes('female'));
        if(voices.length>0) ttsUtterance.voice = voices[0];
      }
      window.speechSynthesis.speak(ttsUtterance);
    }
    function pauseTTS() { window.speechSynthesis.pause(); }
    function setTTSRate(v) {
      ttsRate = Number(v);
      document.getElementById('rateDisplay').innerText = ttsRate.toFixed(1);
      if(ttsUtterance) { ttsUtterance.rate = ttsRate; }
    }

    //-------------------- ËøîÂõûËµ∑Èªû ------------------------
    function restart() {
      origText="";recText="";
      document.getElementById('textInput').value='';
      document.getElementById('step-result').style.display='none';
      document.getElementById('step-audio').style.display='none';
      document.getElementById('step-textinput').style.display='';
    }
  </script>
</body>
</html>
